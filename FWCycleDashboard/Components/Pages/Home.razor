@page "/"
@rendermode InteractiveServer
@using FWCycleDashboard.Data
@using FWCycleDashboard.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject ApplicationDbContext DbContext
@inject RemoteSupervisorClient SupervisorClient
@inject IPoESwitchClient PoESwitchClient
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<h1>Cycle Monitor Dashboard</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="RefreshAll" disabled="@isRefreshing">
        @if (isRefreshing)
        {
            <span class="spinner-border spinner-border-sm me-2"></span>
        }
        Refresh All
    </button>
    <button class="btn btn-secondary ms-2" @onclick="ToggleAutoRefresh">
        Auto-Refresh: @(autoRefreshEnabled ? "On" : "Off")
    </button>
</div>

@if (machineStatuses != null && machineStatuses.Any())
{
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <strong>Service Controls - All Machines</strong>
                </div>
                <div class="card-body p-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-success"
                                @onclick="() => BulkStartAll()"
                                disabled="@isBulkOperating"
                                title="Start All Services">
                            <i class="bi bi-play-fill"></i> Start All
                        </button>
                        <button class="btn btn-warning"
                                @onclick="() => BulkRestartAll()"
                                disabled="@isBulkOperating"
                                title="Restart All Services">
                            <i class="bi bi-arrow-clockwise"></i> Restart All
                        </button>
                        <button class="btn btn-danger"
                                @onclick="() => BulkStopAll()"
                                disabled="@isBulkOperating"
                                title="Stop All Services">
                            <i class="bi bi-stop-fill"></i> Stop All
                        </button>
                    </div>
                </div>
            </div>
        </div>
        @{
            var poeMachines = machines.Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue).ToList();
        }
        @if (poeMachines.Any())
        {
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning">
                        <strong>PoE Controls - All Machines</strong>
                    </div>
                    <div class="card-body p-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-primary"
                                    @onclick="() => BulkPoEPowerCycle()"
                                    disabled="@isBulkOperating"
                                    title="Power Cycle All (PoE)"
                                    style="position: relative;">
                                <i class="bi bi-power"></i>
                                <i class="bi bi-arrow-clockwise" style="position: absolute; font-size: 0.6rem; top: 2px; right: 2px;"></i>
                                Power Cycle All
                            </button>
                            <button class="btn btn-danger"
                                    @onclick="() => BulkPoEPowerDown()"
                                    disabled="@isBulkOperating"
                                    title="Power Down All (PoE)">
                                <i class="bi bi-power"></i> Power Down All
                            </button>
                            <button class="btn btn-success"
                                    @onclick="() => BulkPoEPowerOn()"
                                    disabled="@isBulkOperating"
                                    title="Power On All (PoE)">
                                <i class="bi bi-power"></i> Power On All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (machineStatuses == null)
{
    <p><em>Loading...</em></p>
}
else if (!machineStatuses.Any())
{
    <div class="alert alert-info">
        <h4>No machines configured</h4>
        <p>Get started by adding machines to monitor.</p>
        <a href="/machines" class="btn btn-primary">Add Machines</a>
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-md-2 col-sm-6 mb-2">
            <div class="card bg-success text-white compact-card">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1">Online</h6>
                    <h3 class="mb-0">@machineStatuses.Count(m => m.IsOnline && m.Status?.ActiveState == "active")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-2">
            <div class="card bg-danger text-white compact-card">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1">Stopped</h6>
                    <h3 class="mb-0">@machineStatuses.Count(m => m.IsOnline && m.Status?.ActiveState != "active")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-2">
            <div class="card bg-secondary text-white compact-card">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1">Offline</h6>
                    <h3 class="mb-0">@machineStatuses.Count(m => !m.IsOnline)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-6 mb-2">
            <div class="card bg-info text-white compact-card">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1">Total</h6>
                    <h3 class="mb-0">@machineStatuses.Count</h3>
                </div>
            </div>
        </div>
    </div>

    @if (groups != null && groups.Any())
    {
        <h4 class="mt-4 mb-3">Group Controls</h4>
        <div class="row mb-4">
            @foreach (var group in groups)
            {
                var groupMachines = GetMachinesInGroup(group.Id);
                var onlineCount = groupMachines.Count(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true);
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card border-primary group-tile">
                        <div class="card-header bg-primary text-white" style="cursor: pointer;" @onclick="() => FilterByGroup(group.Id)" title="Click to filter machines by this group">
                            <strong>@group.Name</strong>
                            <span class="badge bg-light text-dark float-end">@onlineCount/@groupMachines.Count online</span>
                        </div>
                        <div class="card-body p-2">
                            <div class="mb-2">
                                <small class="text-muted d-block mb-1"><strong>Service Controls:</strong></small>
                                <div class="btn-group btn-group-sm w-100 mb-1" role="group">
                                    <button class="btn btn-success"
                                            @onclick="() => BulkStartGroup(group.Id)"
                                            disabled="@(isBulkOperating || onlineCount == 0)"
                                            title="Start All Services">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button class="btn btn-warning"
                                            @onclick="() => BulkRestartGroup(group.Id)"
                                            disabled="@(isBulkOperating || onlineCount == 0)"
                                            title="Restart All Services">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-danger"
                                            @onclick="() => BulkStopGroup(group.Id)"
                                            disabled="@(isBulkOperating || onlineCount == 0)"
                                            title="Stop All Services">
                                        <i class="bi bi-stop-fill"></i>
                                    </button>
                                </div>
                            </div>

                            @{
                                var groupPoeCount = groupMachines.Count(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue);
                            }

                            @if (groupPoeCount > 0)
                            {
                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1"><strong>PoE Power Controls:</strong></small>
                                    <div class="btn-group btn-group-sm w-100 mb-1" role="group">
                                        <button class="btn btn-primary"
                                                @onclick="() => BulkPoEPowerCycleGroup(group.Id)"
                                                disabled="@isBulkOperating"
                                                title="Power Cycle Group"
                                                style="position: relative;">
                                            <i class="bi bi-power"></i>
                                            <i class="bi bi-arrow-clockwise" style="position: absolute; font-size: 0.6rem; top: 2px; right: 2px;"></i>
                                        </button>
                                        <button class="btn btn-danger"
                                                @onclick="() => BulkPoEPowerDownGroup(group.Id)"
                                                disabled="@isBulkOperating"
                                                title="Power Down Group">
                                            <i class="bi bi-power"></i>
                                        </button>
                                        <button class="btn btn-success"
                                                @onclick="() => BulkPoEPowerOnGroup(group.Id)"
                                                disabled="@isBulkOperating"
                                                title="Power On Group">
                                            <i class="bi bi-power"></i>
                                        </button>
                                    </div>
                                </div>
                            }

                            <div class="border-top pt-2">
                                <small class="text-muted d-block mb-1"><strong>Stack Lights:</strong></small>
                                <div class="btn-group btn-group-sm w-100 mb-1" role="group">
                                    <button class="btn btn-outline-success"
                                            @onclick="() => BulkStackLightGroup(group.Id, true, false, false)"
                                            disabled="@(isBulkOperating || onlineCount == 0)">
                                        Green
                                    </button>
                                    <button class="btn btn-outline-warning"
                                            @onclick="() => BulkStackLightGroup(group.Id, false, true, false)"
                                            disabled="@(isBulkOperating || onlineCount == 0)">
                                        Amber
                                    </button>
                                    <button class="btn btn-outline-danger"
                                            @onclick="() => BulkStackLightGroup(group.Id, false, false, true)"
                                            disabled="@(isBulkOperating || onlineCount == 0)">
                                        Red
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button class="btn btn-outline-primary"
                                            @onclick="() => BulkTestStackLightGroup(group.Id)"
                                            disabled="@(isBulkOperating || onlineCount == 0)">
                                        @if (isBulkOperating && currentBulkGroupId == group.Id && currentBulkOp == "test")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Test
                                    </button>
                                    <button class="btn btn-outline-secondary"
                                            @onclick="() => BulkStackLightGroup(group.Id, false, false, false)"
                                            disabled="@(isBulkOperating || onlineCount == 0)">
                                        All Off
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <h4 class="mt-4 mb-3">
        Machines
        @if (selectedGroupId.HasValue)
        {
            var selectedGroup = groups.FirstOrDefault(g => g.Id == selectedGroupId.Value);
            <span class="badge bg-primary">Filtered by: @selectedGroup?.Name</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="ClearGroupFilter">Show All</button>
        }
    </h4>
    <div class="mb-3">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Search machines by ID, IP, or group..." @bind="searchTerm" @bind:event="oninput" />
            @if (!string.IsNullOrEmpty(searchTerm))
            {
                <button class="btn btn-outline-secondary" @onclick="ClearSearch"><i class="bi bi-x-circle"></i></button>
            }
        </div>
    </div>
    <div class="row">
        @foreach (var status in GetFilteredMachineStatuses())
        {
            var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
            if (machine != null)
            {
                <div class="col-md-3 col-lg-2 mb-3">
                    <div class="card @GetCardClass(status) machine-tile">
                        <div class="card-header py-1 px-2">
                            <small><strong>@machine.MachineId</strong></small>
                            <span class="badge @GetStatusBadge(status) float-end" style="font-size: 0.65rem;">
                                @(status.IsOnline ? (status.Status?.ActiveState ?? "unknown") : "offline")
                            </span>
                        </div>
                        <div class="card-body p-2">
                            @{
                                var allGroups = new List<MachineGroup>();
                                if (machine.Group != null) allGroups.Add(machine.Group);
                                allGroups.AddRange(machine.Groups.Where(g => machine.GroupId == null || g.Id != machine.GroupId));
                            }
                            @if (allGroups.Any())
                            {
                                <p class="text-muted mb-1" style="font-size: 0.7rem;">@string.Join(", ", allGroups.Select(g => g.Name))</p>
                            }
                            <p class="mb-1" style="font-size: 0.7rem;">@machine.IpAddress:@machine.Port</p>
                            @if (status.IsOnline && status.Status != null)
                            {
                                @if (status.Status.UptimeSeconds.HasValue)
                                {
                                    <p class="mb-1" style="font-size: 0.7rem;">Up: @FormatUptime(status.Status.UptimeSeconds.Value)</p>
                                }
                            }

                            @if (status.IsOnline && status.Metrics != null)
                            {
                                <div class="border-top mt-1 pt-1">
                                    @if (status.Metrics.LastCycleSeconds.HasValue)
                                    {
                                        <p class="mb-0" style="font-size: 0.7rem;"><strong>Last:</strong> @FormatCycleTime(status.Metrics.LastCycleSeconds.Value)</p>
                                    }
                                    @if (status.Metrics.WindowAverages != null && status.Metrics.WindowAverages.Any())
                                    {
                                        var first = status.Metrics.WindowAverages.OrderBy(w => ParseWindowMinutes(w.Key)).FirstOrDefault();
                                        @if (first.Value.HasValue)
                                        {
                                            <p class="mb-0" style="font-size: 0.7rem;"><strong>@first.Key:</strong> @FormatCycleTime(first.Value.Value)</p>
                                        }
                                    }
                                </div>
                            }
                        </div>
                        <div class="card-footer p-2">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><strong>Service Control:</strong></small>
                            <div class="btn-group btn-group-sm w-100 mb-1" role="group">
                                <button class="btn btn-success" @onclick="() => StartService(machine)" disabled="@(!status.IsOnline)" title="Start">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="btn btn-warning" @onclick="() => RestartService(machine)" disabled="@(!status.IsOnline)" title="Restart">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-danger" @onclick="() => StopService(machine)" disabled="@(!status.IsOnline)" title="Stop">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                            </div>

                            @if (!string.IsNullOrEmpty(machine.PoESwitchIp) && machine.PoESwitchPort.HasValue)
                            {
                                <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><strong>PoE Power:</strong></small>
                                <div class="btn-group btn-group-sm w-100 mb-1" role="group">
                                    <button class="btn btn-primary" @onclick="() => PowerCycleViaPOE(machine)" title="Power Cycle (PoE)" style="position: relative;">
                                        <i class="bi bi-power"></i>
                                        <i class="bi bi-arrow-clockwise" style="position: absolute; font-size: 0.6rem; top: 2px; right: 2px;"></i>
                                    </button>
                                    <button class="btn btn-danger" @onclick="() => PowerDownViaPOE(machine)" title="Power Down (PoE)">
                                        <i class="bi bi-power"></i>
                                    </button>
                                    <button class="btn btn-success" @onclick="() => PowerOnViaPOE(machine)" title="Power On (PoE)">
                                        <i class="bi bi-power"></i>
                                    </button>
                                </div>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-danger w-100 mb-1" @onclick="() => RebootPi(machine)" disabled="@(!status.IsOnline)" style="font-size: 0.7rem;">
                                    Reboot Pi
                                </button>
                            }

                            @if (status.StackLight != null)
                            {
                                <div class="border-top pt-1">
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <button class="btn @(status.StackLight.Green ? "btn-success" : "btn-outline-success")"
                                                @onclick="() => SetStackLight(machine, true, false, false)"
                                                disabled="@(!status.IsOnline)"
                                                title="Green">
                                            G
                                        </button>
                                        <button class="btn @(status.StackLight.Amber ? "btn-warning" : "btn-outline-warning")"
                                                @onclick="() => SetStackLight(machine, false, true, false)"
                                                disabled="@(!status.IsOnline)"
                                                title="Amber">
                                            A
                                        </button>
                                        <button class="btn @(status.StackLight.Red ? "btn-danger" : "btn-outline-danger")"
                                                @onclick="() => SetStackLight(machine, false, false, true)"
                                                disabled="@(!status.IsOnline)"
                                                title="Red">
                                            R
                                        </button>
                                        <button class="btn btn-outline-secondary"
                                                @onclick="() => TurnOffStackLight(machine)"
                                                disabled="@(!status.IsOnline)"
                                                title="All Off">
                                            Off
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    private List<Machine> machines = new();
    private List<MachineGroup> groups = new();
    private List<MachineStatus>? machineStatuses;
    private bool isRefreshing = false;
    private bool autoRefreshEnabled = true;
    private bool isBulkOperating = false;
    private string? currentBulkOp;
    private int? currentBulkGroupId;
    private System.Threading.Timer? refreshTimer;
    private string searchTerm = string.Empty;
    private int? selectedGroupId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadMachines();
        await RefreshAll();
        StartAutoRefresh();
    }

    private async Task LoadMachines()
    {
        machines = await DbContext.Machines
            .Include(m => m.Group)
            .Include(m => m.Groups)
            .ToListAsync();
        groups = await DbContext.MachineGroups.ToListAsync();
    }

    private IEnumerable<MachineStatus> GetFilteredMachineStatuses()
    {
        if (machineStatuses == null) return Enumerable.Empty<MachineStatus>();

        var filtered = machineStatuses.AsEnumerable();

        // Filter by selected group
        if (selectedGroupId.HasValue)
        {
            filtered = filtered.Where(status =>
            {
                var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
                return machine != null && (machine.GroupId == selectedGroupId.Value ||
                    machine.Groups.Any(g => g.Id == selectedGroupId.Value));
            });
        }

        // Filter by search term
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var search = searchTerm.ToLower();
            filtered = filtered.Where(status =>
            {
                var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
                if (machine == null) return false;

                return machine.MachineId.ToLower().Contains(search) ||
                    machine.IpAddress.ToLower().Contains(search) ||
                    (machine.Group?.Name.ToLower().Contains(search) ?? false) ||
                    machine.Groups.Any(g => g.Name.ToLower().Contains(search));
            });
        }

        return filtered;
    }

    private void FilterByGroup(int groupId)
    {
        selectedGroupId = groupId;
        searchTerm = string.Empty;
    }

    private void ClearGroupFilter()
    {
        selectedGroupId = null;
    }

    private void ClearSearch()
    {
        searchTerm = string.Empty;
    }

    private async Task RefreshAll()
    {
        isRefreshing = true;
        StateHasChanged();
        try
        {
            var tasks = machines.Select(m => SupervisorClient.GetFullStatusAsync(m));
            machineStatuses = (await Task.WhenAll(tasks)).ToList();
            foreach (var status in machineStatuses.Where(s => s.IsOnline))
            {
                var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
                if (machine != null)
                {
                    machine.LastSeenAt = DateTime.UtcNow;
                    machine.LastStatus = status.Status?.ActiveState;
                }
            }
            await DbContext.SaveChangesAsync();
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task RefreshSingle(Machine machine)
    {
        var updated = await SupervisorClient.GetFullStatusAsync(machine);
        if (machineStatuses != null)
        {
            var index = machineStatuses.FindIndex(s => s.MachineId == machine.Id);
            if (index >= 0)
                machineStatuses[index] = updated;
            else
                machineStatuses.Add(updated);
        }

        if (updated.IsOnline)
        {
            machine.LastSeenAt = DateTime.UtcNow;
            machine.LastStatus = updated.Status?.ActiveState;
            await DbContext.SaveChangesAsync();
        }

        StateHasChanged();
    }

    private async Task StartService(Machine machine)
    {
        var (success, error) = await SupervisorClient.StartServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "start",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshSingle(machine);
    }

    private async Task StopService(Machine machine)
    {
        var (success, error) = await SupervisorClient.StopServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stop",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshSingle(machine);
    }

    private async Task RestartService(Machine machine)
    {
        var (success, error) = await SupervisorClient.RestartServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "restart",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshSingle(machine);
    }

    private string GetCardClass(MachineStatus status)
    {
        if (!status.IsOnline) return "border-secondary";
        return status.Status?.ActiveState == "active" ? "border-success" : "border-danger";
    }

    private string GetStatusBadge(MachineStatus status)
    {
        if (!status.IsOnline) return "bg-secondary";
        return status.Status?.ActiveState == "active" ? "bg-success" : "bg-danger";
    }

    private string FormatUptime(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalDays >= 1)
            return $"{(int)ts.TotalDays}d {ts.Hours}h";
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{(int)ts.TotalMinutes}m";
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (autoRefreshEnabled)
            {
                await InvokeAsync(async () => await RefreshAll());
            }
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void ToggleAutoRefresh()
    {
        autoRefreshEnabled = !autoRefreshEnabled;
    }

    private async Task SetStackLight(Machine machine, bool green, bool amber, bool red)
    {
        var (success, error) = await SupervisorClient.SetStackLightAsync(machine, green, amber, red);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = $"stacklight: G={green} A={amber} R={red}",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(500);
        await RefreshSingle(machine);
    }

    private async Task TestStackLight(Machine machine)
    {
        var (success, error) = await SupervisorClient.TestStackLightAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stacklight: test",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        // Wait for test sequence to complete (8 seconds) plus buffer
        await Task.Delay(9000);
        await RefreshSingle(machine);
    }

    private async Task TurnOffStackLight(Machine machine)
    {
        var (success, error) = await SupervisorClient.TurnOffStackLightAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stacklight: all off",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(500);
        await RefreshSingle(machine);
    }

    private string FormatTimestamp(string? timestamp)
    {
        if (string.IsNullOrEmpty(timestamp))
            return "Unknown";

        if (DateTime.TryParse(timestamp, out var dt))
        {
            var localTime = dt.ToLocalTime();
            var diff = DateTime.Now - localTime;

            if (diff.TotalSeconds < 60)
                return "Just now";
            if (diff.TotalMinutes < 60)
                return $"{(int)diff.TotalMinutes}m ago";
            if (diff.TotalHours < 24)
                return $"{(int)diff.TotalHours}h ago";

            return localTime.ToString("g");
        }

        return timestamp;
    }

    private string FormatCycleTime(double seconds)
    {
        return $"{seconds:F1}s";
    }

    private int ParseWindowMinutes(string windowKey)
    {
        // Extract number from strings like "5min", "15min", "30min", "60min"
        var numericPart = new string(windowKey.TakeWhile(char.IsDigit).ToArray());
        return int.TryParse(numericPart, out var minutes) ? minutes : int.MaxValue;
    }

    private async Task RebootPi(Machine machine)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Reboot {machine.MachineId}? The Raspberry Pi will restart and may take 1-2 minutes to come back online."
        );

        if (!confirmed) return;

        var (success, error) = await SupervisorClient.RebootPiAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "system: reboot",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        // Pi will be offline during reboot, wait 30 seconds before refresh
        await Task.Delay(30000);
        await RefreshSingle(machine);
    }

    private async Task PowerCycleViaPOE(Machine machine)
    {
        if (string.IsNullOrEmpty(machine.PoESwitchIp) || !machine.PoESwitchPort.HasValue)
        {
            await JSRuntime.InvokeVoidAsync("alert", "PoE switch configuration is missing for this machine.");
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power cycle {machine.MachineId} via PoE switch? This will cut power to the Raspberry Pi and restore it after 3 seconds."
        );

        if (!confirmed) return;

        var (success, error) = await PoESwitchClient.PowerCyclePortAsync(
            machine.PoESwitchIp,
            machine.PoESwitchPort.Value,
            waitSeconds: 3
        );

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = $"poe: power cycle (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        if (!success)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Power cycle failed: {error}");
        }

        // Pi will be offline during power cycle, wait 30 seconds before refresh
        await Task.Delay(30000);
        await RefreshSingle(machine);
    }

    private async Task PowerDownViaPOE(Machine machine)
    {
        if (string.IsNullOrEmpty(machine.PoESwitchIp) || !machine.PoESwitchPort.HasValue)
        {
            await JSRuntime.InvokeVoidAsync("alert", "PoE switch configuration is missing for this machine.");
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power down {machine.MachineId} via PoE switch? This will cut power to the Raspberry Pi."
        );

        if (!confirmed) return;

        var (success, error) = await PoESwitchClient.DisablePortAsync(
            machine.PoESwitchIp,
            machine.PoESwitchPort.Value
        );

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = $"poe: power down (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        if (!success)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Power down failed: {error}");
        }

        await Task.Delay(5000);
        await RefreshSingle(machine);
    }

    private async Task PowerOnViaPOE(Machine machine)
    {
        if (string.IsNullOrEmpty(machine.PoESwitchIp) || !machine.PoESwitchPort.HasValue)
        {
            await JSRuntime.InvokeVoidAsync("alert", "PoE switch configuration is missing for this machine.");
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power on {machine.MachineId} via PoE switch? This will restore power to the Raspberry Pi."
        );

        if (!confirmed) return;

        var (success, error) = await PoESwitchClient.EnablePortAsync(
            machine.PoESwitchIp,
            machine.PoESwitchPort.Value
        );

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = $"poe: power on (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        if (!success)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Power on failed: {error}");
        }

        await Task.Delay(30000);
        await RefreshSingle(machine);
    }

    private async Task BulkPoEPowerCycle()
    {
        var poeMachines = machines.Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue).ToList();

        if (!poeMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power cycle {poeMachines.Count} machine(s) via PoE? All machines will be power cycled."
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = poeMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.PowerCyclePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value,
                    waitSeconds: 3
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power cycle all (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(30000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkPoEPowerDown()
    {
        var poeMachines = machines.Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue).ToList();

        if (!poeMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power down {poeMachines.Count} machine(s) via PoE? All machines will be powered off."
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = poeMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.DisablePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power down all (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(5000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkPoEPowerOn()
    {
        var poeMachines = machines.Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue).ToList();

        if (!poeMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power on {poeMachines.Count} machine(s) via PoE? All machines will be powered on."
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = poeMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.EnablePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power on all (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(30000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkPoEPowerCycleGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId)
            .Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue)
            .ToList();

        if (!groupMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power cycle {groupMachines.Count} machine(s) in this group via PoE?"
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = groupMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.PowerCyclePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value,
                    waitSeconds: 3
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power cycle group (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(30000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkPoEPowerDownGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId)
            .Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue)
            .ToList();

        if (!groupMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power down {groupMachines.Count} machine(s) in this group via PoE?"
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = groupMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.DisablePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power down group (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(5000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkPoEPowerOnGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId)
            .Where(m => !string.IsNullOrEmpty(m.PoESwitchIp) && m.PoESwitchPort.HasValue)
            .ToList();

        if (!groupMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Power on {groupMachines.Count} machine(s) in this group via PoE?"
        );

        if (!confirmed) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = groupMachines.Select(async machine =>
            {
                var (success, error) = await PoESwitchClient.EnablePortAsync(
                    machine.PoESwitchIp!,
                    machine.PoESwitchPort!.Value
                );
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"poe: power on group (switch={machine.PoESwitchIp}, port={machine.PoESwitchPort})",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(30000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkStartAll()
    {
        var onlineMachines = machines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.StartServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "start (all)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkRestartAll()
    {
        var onlineMachines = machines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.RestartServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "restart (all)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkStopAll()
    {
        var onlineMachines = machines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.StopServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "stop (all)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkStartGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.StartServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "start (group)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkRestartGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.RestartServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "restart (group)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkStopGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.StopServiceAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "stop (group)",
                    Success = success,
                    Error = error
                });
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(1000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkRebootGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Reboot {onlineMachines.Count} machine(s) in this group? All Raspberry Pis will restart."
        );

        if (!confirmed) return;

        isBulkOperating = true;
        currentBulkOp = "reboot";
        currentBulkGroupId = groupId;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.RebootPiAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "system: reboot (group)",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(30000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            currentBulkOp = null;
            currentBulkGroupId = null;
            StateHasChanged();
        }
    }

    private async Task BulkStackLightGroup(int groupId, bool green, bool amber, bool red)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.SetStackLightAsync(machine, green, amber, red);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"stacklight (group): G={green} A={amber} R={red}",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(500);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkTestStackLightGroup(int groupId)
    {
        var groupMachines = GetMachinesInGroup(groupId);
        var onlineMachines = groupMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any()) return;

        isBulkOperating = true;
        currentBulkOp = "test";
        currentBulkGroupId = groupId;
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.TestStackLightAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "stacklight: test (group)",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            await Task.Delay(9000);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            currentBulkOp = null;
            currentBulkGroupId = null;
            StateHasChanged();
        }
    }

    // Helper method to get all machines in a group (from both legacy and many-to-many relationships)
    private List<Machine> GetMachinesInGroup(int groupId)
    {
        return machines
            .Where(m => m.GroupId == groupId || m.Groups.Any(g => g.Id == groupId))
            .Distinct()
            .ToList();
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
