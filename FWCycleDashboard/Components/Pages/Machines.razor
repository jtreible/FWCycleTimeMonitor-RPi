@page "/machines"
@rendermode InteractiveServer
@using FWCycleDashboard.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation

<PageTitle>Machines</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Machines</h1>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowAddMachine">
                Add Machine
            </button>
        </div>
    </div>

    @if (machines == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Machine ID</th>
                    <th>IP Address</th>
                    <th>Port</th>
                    <th>Groups</th>
                    <th>Location</th>
                    <th>Last Seen</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var machine in machines)
                {
                    <tr>
                        <td>@machine.MachineId</td>
                        <td>@machine.IpAddress</td>
                        <td>@machine.Port</td>
                        <td>
                            @{
                                var allGroups = new List<MachineGroup>();
                                if (machine.Group != null) allGroups.Add(machine.Group);
                                allGroups.AddRange(machine.Groups.Where(g => machine.GroupId == null || g.Id != machine.GroupId));
                            }
                            @if (allGroups.Any())
                            {
                                @string.Join(", ", allGroups.Select(g => g.Name))
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>@(machine.Location ?? "-")</td>
                        <td>
                            @if (machine.LastSeenAt.HasValue)
                            {
                                @machine.LastSeenAt.Value.ToLocalTime().ToString("g")
                            }
                            else
                            {
                                <span class="text-muted">Never</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" @onclick="() => EditMachine(machine)">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger ms-2" @onclick="() => DeleteMachine(machine)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@* Add/Edit Modal *@
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingMachine.Id == 0 ? "Add Machine" : "Edit Machine")</h5>
                    <button type="button" class="btn-close" @onclick="HideModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Machine ID</label>
                        <input type="text" class="form-control" @bind="editingMachine.MachineId" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP Address</label>
                        <input type="text" class="form-control" @bind="editingMachine.IpAddress" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" @bind="editingMachine.Port" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" @bind="editingMachine.ApiKey" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Groups (select one or more)</label>
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            @foreach (var group in groups)
                            {
                                <div class="form-check">
                                    <input type="checkbox"
                                           class="form-check-input"
                                           id="group_@group.Id"
                                           checked="@selectedGroupIds.Contains(group.Id)"
                                           @onchange="@((e) => ToggleGroup(group.Id, (bool)(e.Value ?? false)))" />
                                    <label class="form-check-label" for="group_@group.Id">
                                        @group.Name
                                    </label>
                                </div>
                            }
                            @if (!groups.Any())
                            {
                                <small class="text-muted">No groups available. Create groups first.</small>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location (optional)</label>
                        <input type="text" class="form-control" @bind="editingMachine.Location" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control" rows="2" @bind="editingMachine.Description"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" @bind="editingMachine.UseHttps" />
                        <label class="form-check-label">Use HTTPS</label>
                    </div>

                    <hr />
                    <h6 class="mb-3">PoE Switch Configuration (for Remote Power Cycle)</h6>
                    <div class="mb-3">
                        <label class="form-label">PoE Switch IP Address (optional)</label>
                        <input type="text" class="form-control" @bind="editingMachine.PoESwitchIp" placeholder="192.168.1.100" />
                        <small class="form-text text-muted">IP address of the PoE switch managing this machine</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PoE Switch Port Number (optional)</label>
                        <input type="number" class="form-control" @bind="editingMachine.PoESwitchPort" placeholder="8" min="1" max="48" />
                        <small class="form-text text-muted">Physical port number on the PoE switch (1-48)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveMachine">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Machine>? machines;
    private List<MachineGroup> groups = new();
    private bool showModal = false;
    private Machine editingMachine = new();
    private HashSet<int> selectedGroupIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        machines = await DbContext.Machines
            .Include(m => m.Group)
            .Include(m => m.Groups)
            .OrderBy(m => m.MachineId)
            .ToListAsync();

        groups = await DbContext.MachineGroups
            .OrderBy(g => g.Name)
            .ToListAsync();
    }

    private void ShowAddMachine()
    {
        editingMachine = new Machine { Port = 8443 };
        selectedGroupIds.Clear();
        showModal = true;
    }

    private void EditMachine(Machine machine)
    {
        editingMachine = new Machine
        {
            Id = machine.Id,
            MachineId = machine.MachineId,
            IpAddress = machine.IpAddress,
            Port = machine.Port,
            ApiKey = machine.ApiKey,
            GroupId = machine.GroupId,
            Location = machine.Location,
            Description = machine.Description,
            UseHttps = machine.UseHttps,
            PoESwitchIp = machine.PoESwitchIp,
            PoESwitchPort = machine.PoESwitchPort
        };

        // Load selected groups
        selectedGroupIds.Clear();
        if (machine.GroupId.HasValue)
            selectedGroupIds.Add(machine.GroupId.Value);
        foreach (var group in machine.Groups)
        {
            selectedGroupIds.Add(group.Id);
        }

        showModal = true;
    }

    private void ToggleGroup(int groupId, bool isChecked)
    {
        if (isChecked)
        {
            selectedGroupIds.Add(groupId);
        }
        else
        {
            selectedGroupIds.Remove(groupId);
        }
    }

    private async Task SaveMachine()
    {
        if (editingMachine.Id == 0)
        {
            // New machine
            DbContext.Machines.Add(editingMachine);
            await DbContext.SaveChangesAsync();

            // Add selected groups
            var machine = await DbContext.Machines
                .Include(m => m.Groups)
                .FirstAsync(m => m.Id == editingMachine.Id);

            var selectedGroups = await DbContext.MachineGroups
                .Where(g => selectedGroupIds.Contains(g.Id))
                .ToListAsync();

            machine.Groups.Clear();
            foreach (var group in selectedGroups)
            {
                machine.Groups.Add(group);
            }

            // Set primary group to first selected group (for backward compatibility)
            machine.GroupId = selectedGroupIds.FirstOrDefault();
        }
        else
        {
            // Existing machine
            var existing = await DbContext.Machines
                .Include(m => m.Groups)
                .FirstAsync(m => m.Id == editingMachine.Id);

            existing.MachineId = editingMachine.MachineId;
            existing.IpAddress = editingMachine.IpAddress;
            existing.Port = editingMachine.Port;
            existing.ApiKey = editingMachine.ApiKey;
            existing.Location = editingMachine.Location;
            existing.Description = editingMachine.Description;
            existing.UseHttps = editingMachine.UseHttps;
            existing.PoESwitchIp = editingMachine.PoESwitchIp;
            existing.PoESwitchPort = editingMachine.PoESwitchPort;

            // Update groups
            var selectedGroups = await DbContext.MachineGroups
                .Where(g => selectedGroupIds.Contains(g.Id))
                .ToListAsync();

            existing.Groups.Clear();
            foreach (var group in selectedGroups)
            {
                existing.Groups.Add(group);
            }

            // Set primary group to first selected group (for backward compatibility)
            existing.GroupId = selectedGroupIds.FirstOrDefault();
        }

        await DbContext.SaveChangesAsync();
        await LoadData();
        HideModal();
    }

    private async Task DeleteMachine(Machine machine)
    {
        if (confirm($"Are you sure you want to delete machine {machine.MachineId}?"))
        {
            DbContext.Machines.Remove(machine);
            await DbContext.SaveChangesAsync();
            await LoadData();
        }
    }

    private void HideModal()
    {
        showModal = false;
    }

    private bool confirm(string message)
    {
        // In a real app, use a proper confirmation dialog
        // For now, this is a placeholder
        return true;
    }
}
